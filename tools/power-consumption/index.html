
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Power Consumption Log</title>
  <style>
    button {
      padding: 10px 20px;
      margin-left: 10px;
      border: 1px solid #aaa;
      background-color: transparent;
      cursor: pointer;
      transition: 0.3s;
    }
    button.clicked {
      background-color: #007BFF;
      color: white;
    }
    .remarks-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    textarea {
      flex: 1;
    }
  </style>
</head>
<body>
  <h2>Power Consumption Log</h2>
  <p>Date: <input type="date" id="logDate" /></p>
  <p>Operator: <input type="text" id="operatorName" placeholder="Enter your name" /></p>

  <table border="1" cellpadding="8" id="powerTable">
    <thead>
      <tr>
        <th>Equipment</th>
        <th>Initial (12AM)</th>
        <th>Current (12AM)</th>
        <th>Total kWh</th>
      </tr>
    </thead>
    <tbody id="powerBody"></tbody>
  </table>

  <div class="remarks-row">
    <textarea id="remarks" rows="3" placeholder="Shared remarks here..."></textarea>
    <div>
      <button id="saveBtn" onclick="saveToFirebase()">Save</button>
      <button id="sendBtn" onclick="sendToAdmin()">Send to Admin</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0-PNkHDcLW356892joz-8KDVYRXQbShg",
    authDomain: "abnportal-fb070.firebaseapp.com",
    projectId: "abnportal-fb070",
    storageBucket: "abnportal-fb070.appspot.com",
    messagingSenderId: "124537892733",
    appId: "1:124537892733:web:82725bb557f8521348a614",
    measurementId: "G-WJ1YXXGB1C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const equipmentList = [
    "Refrigeration System", "Clean Steam Generator", "Bulk Chemical System",
    "Condensate Return System", "RVAC", "BOILER", "Compressed Dry Air (CDA)",
    "Waste Water Treatment Plant (WWTP)", "Water Treatment Plant (WTP)", "Combined Water Storage (CWS)",
    "Sump Pit Pump 1", "Freezer & Cold Storage", "CIP Line (E7)", "Bottle Washer (E8)",
    "Modular Labeller (E9)", "Container Conveyor (E10)", "Conveyor Lubrication (E11)",
    "Alwin Soy", "Process MCC", "Homogenizer", "Soya Bean Pre-treatment & Handling",
    "Sugar Dissolving", "Container Dryer (E1)", "Packer (E2)", "Unpacker (E3)",
    "Container Depalettiser (E4)", "Pack Washing (E5)", "Inspector (E6)", "Pack Conveyor (E12)",
    "LIPS (E13)", "Wrap Around", "Hydro Sterilizer", "Filler", "DPP", "DLP", "Warehouse",
    "RVAC (220V)", "WWTP (220V)", "DP-WM", "Sump Pit Pump 2", "Accumulation Table"
  ];

  const tbody = document.getElementById("powerBody");

  equipmentList.forEach((eq, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${eq}</td>
      <td><input type="number" id="initial${i}" /></td>
      <td><input type="number" id="current${i}" /></td>
      <td><input type="text" id="kwh${i}" readonly /></td>
    `;
    tbody.appendChild(row);

    setTimeout(() => {
      document.getElementById("initial" + i).addEventListener("input", compute);
      document.getElementById("current" + i).addEventListener("input", compute);
    }, 50);
  });

  function compute() {
    for (let i = 0; i < equipmentList.length; i++) {
      const ini = parseFloat(document.getElementById("initial" + i).value) || 0;
      const cur = parseFloat(document.getElementById("current" + i).value) || 0;
      const kwh = document.getElementById("kwh" + i);
      if (cur > 0 && ini > 0) {
        kwh.value = (cur - ini).toFixed(2);
      } else {
        kwh.value = "";
      }
    }
  }

  window.saveToFirebase = async function () {
    const date = document.getElementById("logDate").value;
    if (!date) return alert("Please select a date.");
    const data = getReadings();
    const docRef = doc(db, "power_logs", date);
    await setDoc(docRef, data);
    document.getElementById("saveBtn").classList.add("clicked");
    alert("Saved locally in Firebase for next user.");
  };

  window.sendToAdmin = async function () {
    const date = document.getElementById("logDate").value;
    const operator = document.getElementById("operatorName").value || "unknown";
    if (!date || !operator) return alert("Please fill in date and operator name.");
    const remarks = document.getElementById("remarks").value;
    const readings = getReadings();
    const data = {
      operator,
      date,
      remarks,
      status: "pending",
      submitted_at: new Date().toISOString(),
      readings
    };
    const docRef = doc(db, "admin_review_logs", date + "_" + operator);
    await setDoc(docRef, data);
    document.getElementById("sendBtn").classList.add("clicked");
    alert("Sent to admin for review.");
  };

  function getReadings() {
    const readings = {};
    for (let i = 0; i < equipmentList.length; i++) {
      const equipment = equipmentList[i];
      readings[equipment] = {
        initial: document.getElementById("initial" + i).value,
        current: document.getElementById("current" + i).value,
        kwh: document.getElementById("kwh" + i).value
      };
    }
    return readings;
  }

  async function loadPreviousDayData() {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yDateStr = yesterday.toISOString().split('T')[0];
    const logDate = today.toISOString().split('T')[0];
    document.getElementById("logDate").value = logDate;

    const yRef = doc(db, "power_logs", yDateStr);
    const ySnap = await getDoc(yRef);
    if (ySnap.exists()) {
      const data = ySnap.data();
      for (let i = 0; i < equipmentList.length; i++) {
        const eq = equipmentList[i];
        if (data[eq]) {
          document.getElementById("initial" + i).value = data[eq].current || "";
        }
      }
      compute();
      alert("Auto-filled initial readings from: " + yDateStr);
    } else {
      alert("No previous data found for " + yDateStr);
    }
  }

  window.addEventListener("load", loadPreviousDayData);
</script>
</body>
</html>
