
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coal Logs / Reports Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; padding: 20px; }
    .modal, .main-content {
      background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .hidden { display: none; }
    .row { margin-bottom: 10px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input[type="text"], textarea, select {
      width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;
    }
    textarea { height: 60px; }
    select[multiple] { height: auto; min-height: 100px; }
    table {
      width: 100%; table-layout: fixed; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #aaa; padding: 8px; text-align: center; word-wrap: break-word;
    }
    td input { width: 100%; box-sizing: border-box; }
    .buttons { margin-top: 10px; text-align: right; }
    .buttons button { padding: 5px 10px; margin-left: 5px; }
  </style>
</head>
<body>

<div id="modal" class="modal">
  <h2>Coal Logs Info</h2>
  <div class="row">
    <label>Team Name (Opscrew)</label>
    <select id="teamName" multiple>
      <option>Ruzzel Arenas</option>
      <option>Jhamir Paul Madamba</option>
      <option>Mike Garcia</option>
      <option>Enrique Austria</option>
      <option>Jhondel Nimes</option>
      <option>Genesis Mendez</option>
      <option>Jeremy Alinsunurin</option>
    </select>
  </div>
  <div class="row">
    <label>Shift</label>
    <label><input type="radio" name="shift" value="Day">We Are  Day Shift</label>
    <label><input type="radio" name="shift" value="Night">We are  Night Shift</label>
  </div>
  <div class="row">
    <label>Operator Name (Mantech)</label>
    <select id="operatorName" multiple>
      <option>Oliver Alcosaba</option>
      <option>Adonis Millianes</option>
      <option>Jerome Saludes</option>
      <option>Ayman Liao</option>
      <option>Nick Lodor</option>
      <option>Alvin Capacete</option>
      <option>Jhonas Magbanua</option>
      <option>Joselito Vargas</option>
      <option>Jhenrize Dacillo</option>
      <option>Junald Abadilla</option>
      <option>Lhon Litiza</option>
      <option>Ronald Villasis</option>
      <option>Jomar Edillo</option>
    </select>
  </div>
  <div class="row"><label>Boiler Main</label><input type="text" id="boilerMain"></div>
  <div class="row"><label>Boiler Backup</label><input type="text" id="boilerBackup"></div>
  <div class="row"><label>Coal Yard Used</label><input type="text" id="coalYard"></div>
  <div class="row"><label>Maxwork</label><input type="text" id="maxwork"></div>
  <div class="buttons">
    <button onclick="submitInitial()">Continue</button>
       <button onclick="useExistingRecord()">Use Existing Record</button>
  </div>
</div>

<div id="main" class="main-content hidden">
  <h2>DASHBOARD </h2>
  <div class="row"><strong>Date:</strong> <span id="dateNow"></span></div>
  <div class="row"><strong>Shift:</strong> <span id="shiftDisplay"></span></div>
  <div class="row"><strong>Team:</strong> <span id="teamDisplay"></span></div>
  <div class="row"><strong>Operator:</strong> <span id="operatorDisplay"></span></div>
  <div class="row"><strong>Boiler Main:</strong> <span id="boilerMainDisplay"></span></div>
  <div class="row"><strong>Boiler Backup:</strong> <span id="boilerBackupDisplay"></span></div>
  <div class="row"><strong>Coal Yard:</strong> <span id="coalYardDisplay"></span></div>
  <div class="row"><strong>Maxwork:</strong> <span id="maxworkDisplay"></span></div>

  <label for="reportBox">Report:</label>
  <textarea id="reportBox"></textarea>
  <div class="buttons">
    <button onclick="saveToFirestore()">Send to Admin</button>
  </div>

  <h3>Hourly Coal Activity Log</h3>
  <table id="logTable">
    <tr><th>Time</th><th>Bucket</th><th>Tapon</th><th>Coal Switch</th></tr>
  </table>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0-PNkHDcLW356892joz-8KDVYRXQbShg",
    authDomain: "abnportal-fb070.firebaseapp.com",
    projectId: "abnportal-fb070",
    storageBucket: "abnportal-fb070.firebasestorage.app",
    messagingSenderId: "124537892733",
    appId: "1:124537892733:web:fcd6cbf3322fed2048a614",
    measurementId: "G-0EYSR80S11"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let meta = {};

  function submitInitial() {
    const team = Array.from(document.getElementById('teamName').selectedOptions).map(opt => opt.value).join(' | ');
    const operator = Array.from(document.getElementById('operatorName').selectedOptions).map(opt => opt.value).join(' | ');
    const shift = document.querySelector('input[name="shift"]:checked')?.value;
    const boilerMain = document.getElementById('boilerMain').value;
    const boilerBackup = document.getElementById('boilerBackup').value;
    const coalYard = document.getElementById('coalYard').value;
    const maxwork = document.getElementById('maxwork').value || "None";

    if (!team || !operator || !shift || !boilerMain || !coalYard) {
      alert("Please fill all required fields.");
      return;
    }

    meta = { team, operator, shift, boilerMain, boilerBackup, coalYard, maxwork };
    document.getElementById('dateNow').textContent = new Date().toLocaleDateString();
    document.getElementById('shiftDisplay').textContent = shift;
    document.getElementById('teamDisplay').textContent = team;
    document.getElementById('operatorDisplay').textContent = operator;
    document.getElementById('boilerMainDisplay').textContent = boilerMain;
    document.getElementById('boilerBackupDisplay').textContent = boilerBackup;
    document.getElementById('coalYardDisplay').textContent = coalYard;
    document.getElementById('maxworkDisplay').textContent = maxwork;

    document.getElementById("modal").classList.add("hidden");
    document.getElementById("main").classList.remove("hidden");

    const table = document.getElementById('logTable');
    const start = shift === "Night" ? 0 : 6;
    const end = shift === "Night" ? 6 : 19;
    for (let i = start; i < end; i++) {
      const hour = i.toString().padStart(2, '0') + ":00";
      table.innerHTML += `<tr><td>${hour}</td><td><input></td><td><input></td><td><input></td></tr>`;
    }
  }

  async function saveToFirestore() {
    const report = document.getElementById("reportBox").value;
    const rows = document.querySelectorAll("#logTable tr");
    let logs = {};

    rows.forEach((row, index) => {
      if (index === 0) return;
      const tds = row.querySelectorAll("td");
      const hour = tds[0].textContent;
      logs[hour] = {
        bucket: tds[1].querySelector("input").value,
        tapon: tds[2].querySelector("input").value,
        switch: tds[3].querySelector("input").value
      };
    });

    const docId = new Date().toISOString().split("T")[0] + "_shift-" + meta.shift.toLowerCase();
    await setDoc(doc(db, "coal_logs", docId), {
      date: new Date().toLocaleDateString(),
      ...meta,
      report: report,
      hourlyLogs: logs
    });

    alert("✅ Log submitted to Firebase!");
  }

  async function useExistingRecord() {
    const shift = document.querySelector('input[name="shift"]:checked')?.value;
    if (!shift) {
      alert("Please select a shift first.");
      return;
    }
    const docId = new Date().toISOString().split("T")[0] + "_shift-" + shift.toLowerCase();
    try {
      const ref = doc(db, "coal_logs", docId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('main').classList.remove('hidden');

        meta = {
          team: data.team,
          operator: data.operator,
          shift: data.shift,
          boilerMain: data.boilerMain,
          boilerBackup: data.boilerBackup,
          coalYard: data.coalYard,
          maxwork: data.maxwork
        };

        document.getElementById('dateNow').textContent = data.date;
        document.getElementById('shiftDisplay').textContent = data.shift;
        document.getElementById('teamDisplay').textContent = data.team;
        document.getElementById('operatorDisplay').textContent = data.operator;
        document.getElementById('boilerMainDisplay').textContent = data.boilerMain;
        document.getElementById('boilerBackupDisplay').textContent = data.boilerBackup;
        document.getElementById('coalYardDisplay').textContent = data.coalYard;
        document.getElementById('maxworkDisplay').textContent = data.maxwork;
        document.getElementById('reportBox').value = data.report || "";

        const table = document.getElementById('logTable');
        table.innerHTML = "<tr><th>Time</th><th>Bucket</th><th>Tapon</th><th>Coal Switch</th></tr>";
        for (const time in data.hourlyLogs) {
          const entry = data.hourlyLogs[time];
          table.innerHTML += `<tr><td>${time}</td><td><input value="${entry.bucket || ''}"></td><td><input value="${entry.tapon || ''}"></td><td><input value="${entry.switch || ''}"></td></tr>`;
        }

        alert("✅ Loaded existing record.");
      } else {
        alert("No existing record found for this shift.");
      }
    } catch (error) {
      console.error("Fetch error:", error);
      alert("Failed to fetch existing record.");
    }
  }
</script>

</body>
</html>
